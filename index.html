<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Allo √ßa pique ‚Äî Gestion Interventions</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117; --surface: #181c27; --surface2: #1f2535;
  --border: #2a3045; --accent: #f5a623; --text: #e8eaf0;
  --muted: #7a8099; --green: #2dd4a0; --red: #ff4d6d; --r: 12px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

header {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 20px; display: flex; align-items: center;
  justify-content: space-between; height: 60px; position: sticky; top: 0; z-index: 100;
}
.logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.2rem; color: var(--accent); display: flex; align-items: center; gap: 8px; }
.logo span { color: var(--text); }
nav { display: flex; gap: 4px; }
nav button {
  background: none; border: none; color: var(--muted);
  font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 500;
  padding: 8px 14px; border-radius: 8px; cursor: pointer; transition: all 0.2s;
}
nav button:hover, nav button.active { background: var(--surface2); color: var(--text); }
nav button.active { color: var(--accent); }

main { max-width: 900px; margin: 0 auto; padding: 24px 20px; }
.page { display: none; }
.page.active { display: block; }

.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
h2 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.5rem; }

.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 10px 18px; border-radius: var(--r); border: none;
  font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: 0.9rem;
  cursor: pointer; transition: all 0.2s;
}
.btn-primary { background: var(--accent); color: #0f1117; }
.btn-primary:hover { background: #ffc654; }
.btn-success { background: var(--green); color: #0f1117; }
.btn-success:hover { opacity: 0.85; }
.btn-danger { background: var(--red); color: #fff; }
.btn-danger:hover { opacity: 0.85; }
.btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }

.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 20px; margin-bottom: 12px; transition: border-color 0.2s; }
.card:hover { border-color: #3d4f70; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.full { grid-column: 1 / -1; }
label { font-size: 0.8rem; font-weight: 500; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
input, select, textarea {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text);
  font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
  padding: 10px 14px; transition: border-color 0.2s; width: 100%;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
textarea { resize: vertical; min-height: 80px; }
select option { background: var(--surface2); }

.badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.badge-rdv { background: #1a3a5c; color: #5bc4ff; }
.badge-ok { background: #1a3d2b; color: var(--green); }

.rdv-card { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
.rdv-info h3 { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
.rdv-info p { font-size: 0.85rem; color: var(--muted); margin-top: 2px; }
.rdv-actions { display: flex; gap: 8px; flex-wrap: wrap; }

.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 28px; }
@media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; }
.stat-val { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.8rem; color: var(--accent); }
.stat-label { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }

.empty { text-align: center; padding: 48px 20px; color: var(--muted); }
.empty-icon { font-size: 3rem; margin-bottom: 12px; }

.archive-table { width: 100%; border-collapse: collapse; }
.archive-table th { font-size: 0.78rem; text-transform: uppercase; color: var(--muted); padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
.archive-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
.archive-table tr:hover td { background: var(--surface2); }

.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; width: 100%; max-width: 740px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-header h3 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.2rem; }
.close-btn { background: none; border: none; color: var(--muted); font-size: 1.3rem; cursor: pointer; padding: 4px 8px; }
.close-btn:hover { color: var(--text); }

.facture-wrap { background: #fff; color: #111; border-radius: var(--r); padding: 28px; font-family: 'DM Sans', sans-serif; }
.f-header { display: flex; justify-content: space-between; margin-bottom: 24px; align-items: flex-start; }
.f-title { font-family: 'Syne', sans-serif; font-size: 2rem; color: #f5a623; font-weight: 800; }
.f-meta { font-size: 0.85rem; color: #555; line-height: 1.7; }
.f-meta strong { color: #111; }
.f-company { text-align: right; }
.f-company-name { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1rem; color: #f5a623; }
.f-parties { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 22px; }
.f-party { background: #f7f7f7; border-radius: 8px; padding: 14px; }
.f-party h4 { font-size: 0.72rem; text-transform: uppercase; color: #888; margin-bottom: 8px; letter-spacing: .05em; }
.f-party p { font-size: 0.88rem; line-height: 1.6; }
.f-table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
.f-table th { background: #f5a623; color: #fff; padding: 9px 12px; text-align: left; font-size: 0.83rem; }
.f-table td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 0.88rem; }
.f-total { text-align: right; margin-bottom: 16px; }
.f-total-line { font-size: 0.88rem; color: #555; margin-bottom: 3px; }
.f-total-ttc { font-size: 1.2rem; font-weight: 700; color: #111; margin-top: 6px; }
.f-mention { font-size: 0.75rem; color: #888; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
.f-sig { margin-top: 18px; border: 2px dashed #ddd; border-radius: 8px; padding: 10px; }
.f-sig p { font-size: 0.8rem; color: #888; margin-bottom: 6px; }
#sigCanvas { border: 1px solid #ccc; border-radius: 6px; cursor: crosshair; touch-action: none; display: block; max-width: 100%; }

.maps-link { display: inline-flex; align-items: center; gap: 4px; font-size: 0.82rem; color: var(--accent); text-decoration: none; margin-top: 4px; }
.maps-link:hover { text-decoration: underline; }

.tarif-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.tarif-row input { flex: 1; }
.tarif-remove { background: none; border: none; color: var(--red); cursor: pointer; font-size: 1.1rem; padding: 4px 8px; }

/* Cascade intervention */
.cascade-step { margin-bottom: 10px; }
.cascade-label { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.06em; color: #aaa; margin-bottom: 6px; }
.cascade-options { display: flex; flex-wrap: wrap; gap: 8px; }
.cascade-btn { padding: 8px 14px; background: var(--bg3); border: 1.5px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 0.87rem; font-family: inherit; transition: all 0.15s; }
.cascade-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(76,175,80,0.08); }
.cascade-btn.selected { border-color: var(--accent); background: rgba(76,175,80,0.15); color: var(--accent); font-weight: 600; }
.tarif-grid-table { width: 100%; border-collapse: collapse; font-size: 0.84rem; }
.tarif-grid-table th { text-align: left; padding: 8px 10px; background: var(--bg3); color: #aaa; font-weight: 500; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
.tarif-grid-table td { padding: 7px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
.tarif-grid-table tr:last-child td { border-bottom: none; }
.tarif-grid-table td:first-child { color: #ddd; }
.tarif-grid-table input[type=number] { width: 80px; padding: 5px 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; text-align: right; }
.tarif-grid-section { margin-bottom: 22px; }
.tarif-grid-section h4 { font-family: Syne; font-size: 0.95rem; color: var(--accent); margin: 0 0 10px 0; padding-bottom: 6px; border-bottom: 1px solid rgba(76,175,80,0.25); }

.info-box { background: #1a2a1a; border: 1px solid #2a4a2a; border-radius: 8px; padding: 12px 16px; font-size: 0.85rem; color: #aaccaa; margin-bottom: 16px; line-height: 1.6; }
.info-box a { color: var(--accent); }

#toast { position: fixed; bottom: 24px; right: 24px; background: var(--green); color: #0f1117; padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; transform: translateY(80px); opacity: 0; transition: all 0.3s; z-index: 999; pointer-events: none; }
#toast.show { transform: translateY(0); opacity: 1; }
#toast.err { background: var(--red); color: #fff; }
</style>
</head>
<body>

<header>
  <div class="logo">
  <img src="data:image/jpeg;base64,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" alt="Allo √ßa pique" style="max-height: 60px; width: auto; display: block;">
</div>
  <nav>
    <button class="active" onclick="goTo('dashboard')">Accueil</button>
    <button onclick="goTo('rdvs')">Rendez-vous</button>
    <button onclick="goTo('archives')">Factures</button>
    <button onclick="goTo('settings')">Param√®tres</button>
  </nav>
</header>

<main>


  <div class="page active" id="page-dashboard">
    <div class="section-header">
      <h2>Tableau de bord</h2>
      <button class="btn btn-primary" onclick="goTo('rdvs'); setTimeout(openNewRdv, 50)">+ Nouveau RDV</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val" id="stat-rdv">0</div><div class="stat-label">RDV √† venir</div></div>
      <div class="stat-card"><div class="stat-val" id="stat-fact">0</div><div class="stat-label">Factures √©mises</div></div>
      <div class="stat-card"><div class="stat-val" id="stat-ca">0 ‚Ç¨</div><div class="stat-label">Chiffre d'affaires</div></div>
      <div class="stat-card"><div class="stat-val" id="stat-benef">0 ‚Ç¨</div><div class="stat-label">B√©n√©fice net <span style="font-size:0.7rem;font-weight:400;color:var(--muted)">(-26%)</span></div></div>
    </div>
    <h2 style="margin-bottom:16px">Prochains rendez-vous</h2>
    <div id="dash-rdvs"></div>
  </div>


  <div class="page" id="page-rdvs">
    <div class="section-header">
      <h2>Rendez-vous</h2>
      <button class="btn btn-primary" onclick="openNewRdv()">+ Nouveau RDV</button>
    </div>
    <div id="rdv-list"></div>
  </div>


  <div class="page" id="page-archives">
    <div class="section-header"><h2>Factures archiv√©es</h2></div>
    <div id="archive-list"></div>
  </div>


  <div class="page" id="page-settings">
    <div class="section-header">
      <h2>Param√®tres</h2>
      <button class="btn btn-primary" onclick="saveSettings()">üíæ Enregistrer</button>
    </div>
    <div class="card">
      <h3 style="font-family:Syne;margin-bottom:16px">Informations soci√©t√©</h3>
      <div class="form-grid">
        <div class="form-group"><label>Nom / Raison sociale</label><input id="s-nom" type="text" placeholder="Mon Entreprise"></div>
        <div class="form-group"><label>SIRET</label><input id="s-siret" type="text" placeholder="123 456 789 00012"></div>
        <div class="form-group"><label>Adresse</label><input id="s-adresse" type="text" placeholder="12 rue des Fleurs"></div>
        <div class="form-group"><label>Ville / Code postal</label><input id="s-ville" type="text" placeholder="31000 Toulouse"></div>
        <div class="form-group"><label>T√©l√©phone</label><input id="s-tel" type="text" placeholder="06 00 00 00 00"></div>
        <div class="form-group"><label>Email professionnel</label><input id="s-email" type="email" placeholder="contact@monentreprise.fr"></div>
        <div class="form-group full"><label>Mention l√©gale facture</label><input id="s-mention" type="text" placeholder="TVA non applicable, art. 293B du CGI"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="font-family:Syne;margin-bottom:8px">Envoi automatique par mail (EmailJS)</h3>
      <div class="info-box">
        Service gratuit jusqu'√† 200 mails/mois. <a href="https://www.emailjs.com/" target="_blank">Cr√©ez un compte sur emailjs.com</a> puis collez vos 3 cl√©s ci-dessous.<br>
        Variables √† utiliser dans votre template EmailJS : <strong>{{to_name}}</strong>, <strong>{{facture_num}}</strong>, <strong>{{intervention}}</strong>, <strong>{{montant}}</strong>, <strong>{{facture_date}}</strong>, <strong>{{from_name}}</strong>, <strong>{{contact_tel}}</strong>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Public Key</label><input id="s-ejs-pub" type="text" placeholder="xxxxxxxxxxxxxxx"></div>
        <div class="form-group"><label>Service ID</label><input id="s-ejs-svc" type="text" placeholder="service_xxxxxxx"></div>
        <div class="form-group full"><label>Template ID</label><input id="s-ejs-tpl" type="text" placeholder="template_xxxxxxx"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="font-family:Syne;margin-bottom:8px">üì∏ Photos des interventions (Cloudinary)</h3>
      <div class="info-box">Cr√©ez un compte gratuit sur <strong>cloudinary.com</strong>, puis cr√©ez un <strong>Upload Preset</strong> non sign√©. Renseignez votre <strong>Cloud Name</strong> et le nom du preset ci-dessous.</div>
      <div class="form-grid">
        <div class="form-group"><label>Cloud Name</label><input id="s-cloudinary-cloud" type="text" placeholder="mon-cloud-name"></div>
        <div class="form-group"><label>Upload Preset</label><input id="s-cloudinary-preset" type="text" placeholder="unsigned_preset"></div>
      </div>
    </div>
      <div style="margin-bottom:16px">
        <h3 style="font-family:Syne">Grille tarifaire</h3>
        <p style="font-size:0.83rem;color:#aaa;margin:6px 0 0 0">Prix en ‚Ç¨ HT selon l'insecte et l'emplacement du nid. Ces prix s'appliquent automatiquement lors de la s√©lection.</p>
      </div>
      <div id="tarif-grid-container"></div>
    </div>
  </div>

</main>

<div class="modal-overlay" id="modal-rdv">
  <div class="modal">
    <div class="modal-header">
      <h3 id="rdv-modal-title">Nouveau rendez-vous</h3>
      <button class="close-btn" onclick="closeModal('modal-rdv')">‚úï</button>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Nom du client *</label><input id="r-nom" type="text" placeholder="Jean Dupont"></div>
      <div class="form-group"><label>T√©l√©phone *</label><input id="r-tel" type="tel" placeholder="06 00 00 00 00"></div>
      <div class="form-group full">
        <label>Adresse d'intervention *</label>
        <input id="r-adresse" type="text" placeholder="12 rue des Acacias, 31000 Toulouse" oninput="updateMapsLink()">
        <a id="maps-link" class="maps-link" href="#" target="_blank" style="display:none">üìç Ouvrir dans Google Maps</a>
      </div>
      <div class="form-group"><label>Date *</label><input id="r-date" type="date"></div>
      <div class="form-group"><label>Heure</label><input id="r-heure" type="time"></div>
      <div class="form-group full" id="rdv-intervention-bloc">
        <label>Type d'intervention *</label>


        <div class="cascade-step" id="step-client">
          <div class="cascade-label">Type de client</div>
          <div class="cascade-options" id="opts-client">
            <button type="button" class="cascade-btn" onclick="selectClient('Particulier')">üè† Particulier</button>
            <button type="button" class="cascade-btn" onclick="selectClient('Voie publique')">üå≥ Voie publique</button>
          </div>
        </div>


        <div class="cascade-step" id="step-insecte" style="display:none">
          <div class="cascade-label">Type d'insecte</div>
          <div class="cascade-options" id="opts-insecte"></div>
        </div>


        <div class="cascade-step" id="step-emplacement" style="display:none">
          <div class="cascade-label">Emplacement du nid</div>
          <div class="cascade-options" id="opts-emplacement">
            <button type="button" class="cascade-btn" onclick="selectEmplacement('sol','Sol')">‚õèÔ∏è Sol</button>
            <button type="button" class="cascade-btn" onclick="selectEmplacement('hauteur','Hauteur d\'homme')">üßç Hauteur d'homme</button>
            <button type="button" class="cascade-btn" onclick="selectEmplacement('arbre','Arbre')">üå≥ Arbre</button>
            <button type="button" class="cascade-btn" onclick="selectEmplacement('cheminee','Chemin√©e')">üèöÔ∏è Chemin√©e</button>
          </div>
        </div>


        <div class="cascade-step" id="step-hauteur" style="display:none">
          <div class="cascade-label">Hauteur de l'arbre</div>
          <div class="cascade-options" id="opts-hauteur">
            <button type="button" class="cascade-btn" onclick="selectHauteur('arbre-0-10','0-10m')">üå± 0-10m</button>
            <button type="button" class="cascade-btn" onclick="selectHauteur('arbre-10-20','10-20m')">üå≤ 10-20m</button>
            <button type="button" class="cascade-btn" onclick="selectHauteur('arbre-20plus','20m et +')">üå≥ 20m et +</button>
          </div>
        </div>


        <div id="intervention-resume" style="display:none;margin-top:10px;padding:10px 14px;background:rgba(76,175,80,0.12);border:1px solid rgba(76,175,80,0.35);border-radius:8px;font-size:0.88rem;color:#e0e0e0">
          <span id="intervention-resume-text"></span>
          <button type="button" onclick="resetCascade()" style="margin-left:10px;background:none;border:none;color:#aaa;cursor:pointer;font-size:0.8rem;text-decoration:underline">Modifier</button>
        </div>

        <input type="hidden" id="r-type">
        <input type="hidden" id="r-client-type">
      </div>
      <div class="form-group"><label>Prix (‚Ç¨)</label><input id="r-prix" type="number" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>Email client</label><input id="r-email" type="email" placeholder="client@mail.fr"></div>
      <div class="form-group full"><label>Notes / D√©tails</label><textarea id="r-notes" placeholder="Nid sous toiture, acc√®s difficile..."></textarea></div>


      <div class="form-group full" id="bloc-mairie" style="display:none">
        <div style="background:rgba(245,166,35,0.1);border:1px solid rgba(245,166,35,0.35);border-radius:10px;padding:14px 16px">
          <div style="font-size:0.82rem;text-transform:uppercase;letter-spacing:.06em;color:#f5a623;margin-bottom:10px;font-weight:600">üèõÔ∏è Facturation √† la mairie</div>
          <div id="mairie-detectee" style="display:none;margin-bottom:10px;font-size:0.88rem;color:#ccc">
            <span id="mairie-nom-display"></span><br>
            <span id="mairie-adr-display" style="color:#aaa;font-size:0.82rem"></span>
          </div>
          <div id="mairie-inconnue" style="display:none;margin-bottom:8px;font-size:0.84rem;color:#f5a623">
            ‚ö†Ô∏è Ville non reconnue ‚Äî saisissez l'adresse de la mairie manuellement
          </div>
          <label style="font-size:0.78rem;color:#aaa;text-transform:uppercase;letter-spacing:.05em">Nom de la mairie</label>
          <input id="r-mairie-nom" type="text" placeholder="Mairie de [Ville]" style="margin-top:5px;margin-bottom:10px">
          <label style="font-size:0.78rem;color:#aaa;text-transform:uppercase;letter-spacing:.05em">Adresse compl√®te de la mairie</label>
          <textarea id="r-mairie-adresse" placeholder="1 Place de l'H√¥tel de Ville, 76600 Le Havre" style="margin-top:5px;min-height:60px"></textarea>
          <label style="font-size:0.78rem;color:#aaa;text-transform:uppercase;letter-spacing:.05em;margin-top:8px;display:block">T√©l√©phone mairie</label>
          <input id="r-mairie-tel" type="tel" placeholder="02 35 00 00 00" style="margin-top:5px">
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modal-rdv')">Annuler</button>
      <button class="btn btn-primary" onclick="saveRdv()">Enregistrer</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-facture">
  <div class="modal" style="max-width:780px">
    <div class="modal-header">
      <h3 id="facture-modal-title">Facture</h3>
      <button class="close-btn" onclick="closeModal('modal-facture')">‚úï</button>
    </div>
    <div id="facture-content"></div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn btn-ghost" onclick="closeModal('modal-facture')">Fermer</button>
      <button class="btn btn-ghost" onclick="printFacture()">üñ®Ô∏è Imprimer / PDF</button>
      <button id="btn-mail" class="btn btn-ghost" style="display:none" onclick="sendMailCurrent()">üìß Envoyer par mail</button>
      <button id="btn-valider" class="btn btn-success" style="display:none" onclick="validerFacture()">‚úì Valider et archiver</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
var rdvs = JSON.parse(localStorage.getItem('nid_rdvs') || '[]');
var factures = JSON.parse(localStorage.getItem('nid_factures') || '[]');
var settings = JSON.parse(localStorage.getItem('nid_settings') || '{}');
// Nouvelle structure : grille de tarifs par combinaison
// tarifs = { insecte_emplacement: prix, ... }
// Insectes : frelon-asiatique, frelon-europeen, guepe, abeille, ne-sais-pas
// Emplacements : sol, hauteur, arbre-0-10, arbre-10-20, arbre-20plus, cheminee
var INSECTES = [
  {id:'frelon-asiatique', label:'Frelon asiatique'},
  {id:'frelon-europeen', label:'Frelon europ√©en'},
  {id:'guepe', label:'Gu√™pe'},
  {id:'abeille', label:'Abeille'},
  {id:'ne-sais-pas', label:'Ne sais pas'}
];
var EMPLACEMENTS = [
  {id:'sol', label:'Sol'},
  {id:'hauteur', label:'Hauteur d\'homme'},
  {id:'arbre-0-10', label:'Arbre (0-10m)'},
  {id:'arbre-10-20', label:'Arbre (10-20m)'},
  {id:'arbre-20plus', label:'Arbre (20m+)'},
  {id:'cheminee', label:'Chemin√©e'}
];
var TARIFS_DEFAULT = {};
INSECTES.forEach(function(ins) {
  EMPLACEMENTS.forEach(function(emp) {
    var prix = emp.id === 'cheminee' ? 100 : 65;
    TARIFS_DEFAULT[ins.id + '_' + emp.id] = prix;
  });
});
var tarifs = JSON.parse(localStorage.getItem('nid_tarifs_v3') || JSON.stringify(TARIFS_DEFAULT));

// ---- BASE DES MAIRIES ----
// Format : { d√©tection: ['le havre', ...], nom: 'Mairie du Havre', adresse: '...', ville: '...', cp: '...', tel: '...' }
var MAIRIES = [
  {
    detection: ['le havre', 'havre'],
    nom: 'Mairie du Havre',
    adresse: '1517 Place de l\'H√¥tel de Ville',
    cp: '76600',
    ville: 'Le Havre',
    tel: '02 35 19 45 45'
  }
  // Ajouter d'autres villes ici au fil du temps
];

function detecterMairie(adresse) {
  if (!adresse) return null;
  var adrLower = adresse.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  for (var i = 0; i < MAIRIES.length; i++) {
    var m = MAIRIES[i];
    for (var j = 0; j < m.detection.length; j++) {
      var mot = m.detection[j].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      if (adrLower.indexOf(mot) !== -1) return m;
    }
  }
  return null;
}

var editingId = null;
var currentRdvId = null;
var currentFactureId = null;
var isDrawing = false;
var lastX = 0;
var lastY = 0;

function save() {
  localStorage.setItem('nid_rdvs', JSON.stringify(rdvs));
  localStorage.setItem('nid_factures', JSON.stringify(factures));
  localStorage.setItem('nid_settings', JSON.stringify(settings));
  localStorage.setItem('nid_tarifs_v3', JSON.stringify(tarifs));
}

function goTo(page) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('nav button').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('page-' + page).classList.add('active');
  var pages = ['dashboard','rdvs','archives','settings'];
  var idx = pages.indexOf(page);
  if (idx >= 0) document.querySelectorAll('nav button')[idx].classList.add('active');
  if (page === 'dashboard') renderDashboard();
  if (page === 'rdvs') renderRdvs();
  if (page === 'archives') renderArchives();
  if (page === 'settings') renderSettings();
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

function showToast(msg, isErr) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = isErr ? 'err show' : 'show';
  setTimeout(function() { t.className = ''; }, 3000);
}

// DASHBOARD
function renderDashboard() {
  var today = new Date().toISOString().split('T')[0];
  var upcoming = rdvs.filter(function(r) { return r.date >= today && !r.factureId; });
  upcoming.sort(function(a,b) { return a.date.localeCompare(b.date); });
  document.getElementById('stat-rdv').textContent = upcoming.length;
  document.getElementById('stat-fact').textContent = factures.length;
  var ca = factures.reduce(function(s,f) { return s + (f.prix || 0); }, 0);
  document.getElementById('stat-ca').textContent = ca.toFixed(0) + ' ‚Ç¨';
  var benef = ca * 0.74;
  document.getElementById('stat-benef').textContent = benef.toFixed(0) + ' ‚Ç¨';
  var el = document.getElementById('dash-rdvs');
  if (upcoming.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üìÖ</div><p>Aucun RDV √† venir</p></div>';
  } else {
    el.innerHTML = upcoming.slice(0,5).map(makeRdvCard).join('');
  }
}

// RDV LIST
function renderRdvs() {
  var sorted = rdvs.slice().sort(function(a,b) { return b.date.localeCompare(a.date); });
  var el = document.getElementById('rdv-list');
  if (sorted.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üóìÔ∏è</div><p>Aucun RDV ‚Äî cr√©ez-en un !</p></div>';
  } else {
    el.innerHTML = sorted.map(makeRdvCard).join('');
  }
}

function makeRdvCard(r) {
  var d = r.date ? new Date(r.date + 'T12:00:00').toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric'}) : '';
  var badge = r.factureId
    ? '<span class="badge badge-ok">Factur√©</span>'
    : '<span class="badge badge-rdv">√Ä venir</span>';
  var actionBtn = r.factureId
    ? '<button class="btn btn-ghost btn-sm" onclick="voirFacture(\'' + r.factureId + '\')">üëÅ Facture</button>'
    : '<button class="btn btn-primary btn-sm" onclick="ouvrirFacture(\'' + r.id + '\')">üìÑ Facturer</button>';
  var photoBtn = '<button class="btn btn-ghost btn-sm" onclick="prendrePhoto(\'' + r.id + '\')" title="Photo du nid">'
    + (r.photoUrl ? 'üì∏' : 'üì∑') + '</button>';
  return '<div class="card"><div class="rdv-card">'
    + '<div class="rdv-info">'
    + '<h3>' + escHtml(r.nom) + ' ' + badge + '</h3>'
    + '<p>üìÖ ' + d + (r.heure ? ' ‚Ä¢ ' + r.heure : '') + ' &nbsp;|&nbsp; üìû ' + escHtml(r.tel) + '</p>'
    + '<p>üìç <a href="https://maps.google.com/?q=' + encodeURIComponent(r.adresse) + '" target="_blank" style="color:var(--accent);text-decoration:none">' + escHtml(r.adresse) + '</a></p>'
    + '<p style="margin-top:4px">üêù ' + escHtml(r.type) + ' ‚Äî <strong>' + parseFloat(r.prix).toFixed(2) + ' ‚Ç¨</strong></p>'
    + (r.notes ? '<p style="color:var(--muted);font-size:0.82rem;margin-top:4px">' + escHtml(r.notes) + '</p>' : '')
    + '</div>'
    + '<div class="rdv-actions">'
    + actionBtn
    + ' ' + photoBtn
    + ' <button class="btn btn-ghost btn-sm" onclick="editRdv(\'' + r.id + '\')">‚úèÔ∏è</button>'
    + ' <button class="btn btn-danger btn-sm" onclick="supprimerRdv(\'' + r.id + '\')">üóë</button>'
    + '</div></div></div>';
}

function escHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function openNewRdv() {
  editingId = null;
  document.getElementById('rdv-modal-title').textContent = 'Nouveau rendez-vous';
  document.getElementById('r-nom').value = '';
  document.getElementById('r-tel').value = '';
  document.getElementById('r-adresse').value = '';
  document.getElementById('r-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('r-heure').value = '';
  document.getElementById('r-email').value = '';
  document.getElementById('r-prix').value = '';
  document.getElementById('r-notes').value = '';
  document.getElementById('maps-link').style.display = 'none';
  resetCascade();
  document.getElementById('modal-rdv').classList.add('open');
}

function editRdv(id) {
  var r = findById(rdvs, id);
  if (!r) return;
  editingId = id;
  document.getElementById('rdv-modal-title').textContent = 'Modifier le rendez-vous';
  document.getElementById('r-nom').value = r.nom;
  document.getElementById('r-tel').value = r.tel;
  document.getElementById('r-adresse').value = r.adresse;
  document.getElementById('r-date').value = r.date;
  document.getElementById('r-heure').value = r.heure || '';
  document.getElementById('r-email').value = r.email || '';
  document.getElementById('r-prix').value = r.prix;
  document.getElementById('r-notes').value = r.notes || '';
  initCascade(r);
  updateMapsLink();
  document.getElementById('modal-rdv').classList.add('open');
}

// ---- CASCADE INTERVENTION ----
var _cascade = { client: null, insecte: null, insecteLabel: null, emplacement: null, emplacementLabel: null };

function resetCascade() {
  _cascade = { client: null, insecte: null, insecteLabel: null, emplacement: null, emplacementLabel: null };
  // Reset UI
  document.querySelectorAll('.cascade-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.getElementById('step-client').style.display = '';
  document.getElementById('step-insecte').style.display = 'none';
  document.getElementById('step-emplacement').style.display = 'none';
  document.getElementById('step-hauteur').style.display = 'none';
  var blocMairie = document.getElementById('bloc-mairie');
  if (blocMairie) blocMairie.style.display = 'none';
  document.getElementById('intervention-resume').style.display = 'none';
  document.getElementById('r-type').value = '';
  document.getElementById('r-client-type').value = '';
}

function selectClient(val) {
  _cascade.client = val;
  // Highlight
  document.querySelectorAll('#opts-client .cascade-btn').forEach(function(b){ b.classList.remove('selected'); if(b.textContent.trim().includes(val.split(' ')[0])) b.classList.add('selected'); });
  // Build insecte buttons
  var container = document.getElementById('opts-insecte');
  container.innerHTML = INSECTES.map(function(ins) {
    var icon = ins.id === 'frelon-asiatique' ? 'üêù' : ins.id === 'frelon-europeen' ? 'üêù' : ins.id === 'guepe' ? 'üêõ' : ins.id === 'abeille' ? 'üçØ' : '‚ùì';
    return '<button type="button" class="cascade-btn" data-id="' + ins.id + '" onclick="selectInsecte(\'' + ins.id + '\',\'' + ins.label.replace(/'/g,"\\'") + '\')">' + icon + ' ' + ins.label + '</button>';
  }).join('');
  document.getElementById('step-insecte').style.display = '';
  document.getElementById('r-client-type').value = val;
  // Afficher/masquer bloc mairie
  updateBlocMairie();
}

function selectInsecte(id, label) {
  _cascade.insecte = id;
  _cascade.insecteLabel = label;
  document.querySelectorAll('#opts-insecte .cascade-btn').forEach(function(b){
    b.classList.toggle('selected', b.dataset.id === id);
  });
  document.getElementById('step-emplacement').style.display = '';
  document.getElementById('step-hauteur').style.display = 'none';
  document.querySelectorAll('#opts-emplacement .cascade-btn').forEach(function(b){ b.classList.remove('selected'); });
}

function selectEmplacement(empId, empLabel) {
  if (empId === 'arbre') {
    _cascade.emplacement = null;
    _cascade.emplacementLabel = empLabel;
    document.querySelectorAll('#opts-emplacement .cascade-btn').forEach(function(b){ b.classList.remove('selected'); if(b.textContent.trim().includes('Arbre')) b.classList.add('selected'); });
    document.getElementById('step-hauteur').style.display = '';
    return;
  }
  _cascade.emplacement = empId;
  _cascade.emplacementLabel = empLabel;
  document.querySelectorAll('#opts-emplacement .cascade-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.querySelectorAll('#opts-emplacement .cascade-btn').forEach(function(b){ if(b.textContent.trim().includes(empLabel.split(' ')[0])) b.classList.add('selected'); });
  document.getElementById('step-hauteur').style.display = 'none';
  finalizeCascade();
}

function selectHauteur(empId, hautLabel) {
  _cascade.emplacement = empId;
  _cascade.emplacementLabel = 'Arbre ' + hautLabel;
  document.querySelectorAll('#opts-hauteur .cascade-btn').forEach(function(b){ b.classList.remove('selected'); if(b.textContent.trim().includes(hautLabel)) b.classList.add('selected'); });
  finalizeCascade();
}

function finalizeCascade() {
  if (!_cascade.client || !_cascade.insecte || !_cascade.emplacement) return;
  var key = _cascade.insecte + '_' + _cascade.emplacement;
  var prix = (tarifs[key] !== undefined) ? tarifs[key] : 0;
  var typeLabel = _cascade.insecteLabel + ' ‚Ä¢ ' + _cascade.emplacementLabel;
  document.getElementById('r-type').value = typeLabel;
  document.getElementById('r-client-type').value = _cascade.client;
  document.getElementById('r-prix').value = prix;
  var resume = 'üë§ ' + _cascade.client + ' ‚Äî ü™≤ ' + _cascade.insecteLabel + ' ‚Äî üìç ' + _cascade.emplacementLabel + ' ‚Äî üí∂ ' + prix + ' ‚Ç¨';
  document.getElementById('intervention-resume-text').textContent = resume;
  document.getElementById('intervention-resume').style.display = '';
}

function initCascade(rdv) {
  resetCascade();
  if (!rdv || !rdv.type) return;
  // Restore from saved rdv
  if (rdv.clientType) {
    selectClient(rdv.clientType);
  }
  // Try to match insecte + emplacement
  if (rdv.insecte && rdv.emplacement) {
    selectInsecte(rdv.insecte, INSECTES.find(function(x){return x.id===rdv.insecte;}) ? INSECTES.find(function(x){return x.id===rdv.insecte;}).label : rdv.insecte);
    if (rdv.emplacement.startsWith('arbre')) {
      selectEmplacement('arbre', 'Arbre');
      var hautLabel = rdv.emplacement === 'arbre-0-10' ? '0-10m' : rdv.emplacement === 'arbre-10-20' ? '10-20m' : '20m et +';
      selectHauteur(rdv.emplacement, hautLabel);
    } else {
      var emp = EMPLACEMENTS.find(function(x){return x.id===rdv.emplacement;});
      if (emp) selectEmplacement(emp.id, emp.label);
    }
  }
  // Restore mairie info if voie publique
  if (rdv.clientType === 'Voie publique') {
    if (rdv.mairieNom) document.getElementById('r-mairie-nom').value = rdv.mairieNom;
    if (rdv.mairieAdresse) document.getElementById('r-mairie-adresse').value = rdv.mairieAdresse;
    if (rdv.mairieTel) document.getElementById('r-mairie-tel').value = rdv.mairieTel;
  }
}

// Legacy compatibility (kept for references elsewhere but no longer used)
function fillTypeSelect(selected) { /* remplac√© par cascade */ }
function onTypeChange() { /* remplac√© par cascade */ }

function updateBlocMairie() {
  var isVP = _cascade.client === 'Voie publique';
  var bloc = document.getElementById('bloc-mairie');
  if (!bloc) return;
  bloc.style.display = isVP ? '' : 'none';
  if (!isVP) return;
  var adresse = (document.getElementById('r-adresse') || {}).value || '';
  var mairie = detecterMairie(adresse);
  if (mairie) {
    document.getElementById('mairie-detectee').style.display = '';
    document.getElementById('mairie-inconnue').style.display = 'none';
    document.getElementById('mairie-nom-display').textContent = mairie.nom;
    document.getElementById('mairie-adr-display').textContent = mairie.adresse + ', ' + mairie.cp + ' ' + mairie.ville;
    document.getElementById('r-mairie-nom').value = mairie.nom;
    document.getElementById('r-mairie-adresse').value = mairie.adresse + '\n' + mairie.cp + ' ' + mairie.ville;
    document.getElementById('r-mairie-tel').value = mairie.tel;
  } else {
    document.getElementById('mairie-detectee').style.display = 'none';
    document.getElementById('mairie-inconnue').style.display = adresse ? '' : 'none';
    // Ne pas effacer si d√©j√† rempli manuellement
  }
}

function updateMapsLink() {
  var adr = document.getElementById('r-adresse').value.trim();
  var link = document.getElementById('maps-link');
  if (adr) {
    link.href = 'https://maps.google.com/?q=' + encodeURIComponent(adr);
    link.style.display = 'inline-flex';
  } else {
    link.style.display = 'none';
  }
  // Re-d√©tecter la mairie si voie publique
  updateBlocMairie();
}

function saveRdv() {
  var nom = document.getElementById('r-nom').value.trim();
  var tel = document.getElementById('r-tel').value.trim();
  var adresse = document.getElementById('r-adresse').value.trim();
  var date = document.getElementById('r-date').value;
  var type = document.getElementById('r-type').value;
  if (!nom || !tel || !adresse || !date || !type) {
    showToast('Remplissez tous les champs obligatoires (*)', true);
    if (!type) showToast('S√©lectionnez le type d\'intervention complet', true);
    return;
  }
  var existing = editingId ? findById(rdvs, editingId) : null;
  var rdv = {
    id: editingId || String(Date.now()),
    nom: nom, tel: tel, adresse: adresse, date: date,
    heure: document.getElementById('r-heure').value,
    type: type,
    clientType: _cascade.client || document.getElementById('r-client-type').value || '',
    insecte: _cascade.insecte || '',
    emplacement: _cascade.emplacement || '',
    prix: parseFloat(document.getElementById('r-prix').value) || 0,
    email: document.getElementById('r-email').value.trim(),
    notes: document.getElementById('r-notes').value.trim(),
    mairieNom: _cascade.client === 'Voie publique' ? (document.getElementById('r-mairie-nom').value.trim()) : '',
    mairieAdresse: _cascade.client === 'Voie publique' ? (document.getElementById('r-mairie-adresse').value.trim()) : '',
    mairieTel: _cascade.client === 'Voie publique' ? (document.getElementById('r-mairie-tel').value.trim()) : '',
    factureId: existing ? existing.factureId : null
  };
  if (editingId) {
    var idx = rdvs.findIndex(function(x) { return x.id === editingId; });
    rdvs[idx] = rdv;
  } else {
    rdvs.push(rdv);
  }
  save();
  closeModal('modal-rdv');
  renderRdvs();
  renderDashboard();
  showToast('RDV enregistr√© !');
}

function supprimerRdv(id) {
  if (!confirm('Supprimer ce rendez-vous ?')) return;
  rdvs = rdvs.filter(function(r) { return r.id !== id; });
  save();
  renderRdvs();
  renderDashboard();
  showToast('RDV supprim√©');
}

// FACTURE HTML BUILDER
function buildFactureHtml(data, withSigCanvas, withEmailInput) {
  var s = settings;
  var prixHT = data.prixHT;
  var total = prixHT;

  var h = '<div class="facture-wrap">';
  h += '<div class="f-header">';
  h += '<div><div class="f-title">FACTURE</div><div class="f-meta"><strong>N¬∞</strong> ' + data.num + '<br><strong>Date :</strong> ' + data.dateStr + '</div></div>';
  h += '<div class="f-company"><img src="data:image/jpeg;base64,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" style="height:50px;object-fit:contain;display:block;margin-bottom:4px;margin-left:auto">';
  h += '<div class="f-meta">' + escHtml(s.adresse||'') + '<br>' + escHtml(s.ville||'') + '<br>' + escHtml(s.tel||'') + '<br>' + escHtml(s.email||'') + '<br>SIRET : ' + escHtml(s.siret||'') + '</div></div>';
  h += '</div>';
  h += '<div class="f-parties">';
  h += '<div class="f-party"><h4>Prestataire</h4><p><strong>' + escHtml(s.nom||'') + '</strong><br>' + escHtml(s.adresse||'') + '<br>' + escHtml(s.ville||'') + '<br>SIRET : ' + escHtml(s.siret||'') + '</p></div>';
  h += '<div class="f-party"><h4>Client</h4><p><strong>' + escHtml(data.nom) + '</strong>' + (data.clientType ? '<br><span style="font-size:0.78rem;color:#888;background:#f0f0f0;padding:1px 6px;border-radius:4px">' + escHtml(data.clientType) + '</span>' : '') + '<br>' + escHtml(data.adresse) + '<br>T√©l : ' + escHtml(data.tel) + (data.email ? '<br>' + escHtml(data.email) : '') + '</p></div>';
  h += '</div>';
  h += '<table class="f-table"><thead><tr><th>Description</th><th>Qt√©</th><th>Prix HT</th><th>Total</th></tr></thead><tbody>';
  h += '<tr><td>' + escHtml(data.type) + (data.notes ? '<br><small style="color:#888">' + escHtml(data.notes) + '</small>' : '') + '</td><td>1</td><td>' + prixHT.toFixed(2) + ' ‚Ç¨</td><td>' + prixHT.toFixed(2) + ' ‚Ç¨</td></tr>';
  h += '</tbody></table>';

  // Aide d√©partementale frelon asiatique ‚Äî particuliers uniquement
  var isFA = (data.insecte === 'frelon-asiatique') || (data.type && data.type.toLowerCase().indexOf('frelon asiatique') >= 0);
  var isParticulier = (data.clientType === 'Particulier');
  if (isFA && isParticulier) {
    var aideAmt = prixHT * 0.30;
    var netApresAide = prixHT - aideAmt;
    total = netApresAide;
    h += '<div style="margin:16px 0;background:#fffbf0;border:2px solid #f5a623;border-radius:10px;padding:14px 18px">';
    h += '<div style="font-weight:700;font-size:0.93rem;color:#b36b00;margin-bottom:10px">üèõÔ∏è Aide d√©partementale ‚Äî Frelon asiatique</div>';
    h += '<table style="width:100%;border-collapse:collapse;font-size:0.88rem">';
    h += '<tr><td style="padding:4px 0;color:#555">Montant intervention</td><td style="text-align:right;font-weight:600;color:#111">' + prixHT.toFixed(2) + ' ‚Ç¨</td></tr>';
    h += '<tr><td style="padding:4px 0;color:#c0392b">Aide d√©partement (‚àí 30%)</td><td style="text-align:right;font-weight:700;color:#c0392b">‚àí ' + aideAmt.toFixed(2) + ' ‚Ç¨</td></tr>';
    h += '<tr style="border-top:2px solid #f5a623"><td style="padding:8px 0 4px;font-weight:700;font-size:1rem;color:#111">Reste √† charge client</td><td style="text-align:right;font-weight:800;font-size:1.1rem;color:#2d7d46;padding:8px 0 4px">' + netApresAide.toFixed(2) + ' ‚Ç¨</td></tr>';
    h += '</table>';
    h += '<div style="font-size:0.75rem;color:#888;margin-top:8px;line-height:1.5">Le prestataire r√©cup√®re 30 % aupr√®s du D√©partement. Le client r√®gle uniquement le montant ¬´ Reste √† charge ¬ª.</div>';
    h += '</div>';
  }

  h += '<div class="f-total">';
  h += '<div class="f-total-ttc">Total client : ' + total.toFixed(2) + ' ‚Ç¨</div></div>';
  h += '<div class="f-mention">' + escHtml(s.mention || 'TVA non applicable, art. 293B du CGI') + '<br>Paiement √† r√©ception de facture.</div>';

  if (withSigCanvas) {
    h += '<div class="f-sig"><p>Signature du client :</p>';
    h += '<canvas id="sigCanvas" width="560" height="110"></canvas>';
    h += '<div style="margin-top:8px"><button onclick="clearSig()" style="font-size:0.8rem;padding:4px 10px;background:#eee;border:none;border-radius:4px;cursor:pointer">Effacer signature</button></div>';
    h += '</div>';
    if (withEmailInput) {
      h += '<div style="margin-top:14px">';
      h += '<label style="font-size:0.78rem;color:#555;text-transform:uppercase;letter-spacing:.05em">Email client pour envoi de la facture</label>';
      h += '<input type="email" id="f-email" value="' + escHtml(data.email||'') + '" placeholder="client@mail.fr" style="margin-top:6px;width:100%;padding:9px 12px;border:1px solid #ddd;border-radius:6px;font-size:0.9rem;color:#111;background:#fff">';
      h += '</div>';
    }
  } else if (data.signature) {
    h += '<div class="f-sig"><p>Signature du client :</p><img src="' + data.signature + '" style="max-width:100%;border:1px solid #ddd;border-radius:6px;display:block"></div>';
  }
  h += '</div>';
  return h;
}

function buildDataFacture(r, num, dateStr) {
  var isVP = r.clientType === 'Voie publique';
  // Description de l'intervention
  var descType = r.type; // d√©j√† "Frelon asiatique ‚Ä¢ Sol" etc.
  if (isVP) {
    // Reconstruire : Insecte + Emplacement + "sur voie publique" + adresse
    descType = r.type + ', sur voie publique ‚Äî ' + r.adresse;
  }
  // Infos client
  var nomClient = r.nom;
  var adrClient = r.adresse;
  var telClient = r.tel;
  if (isVP) {
    nomClient = r.mairieNom || 'Mairie (ville non reconnue)';
    adrClient = r.mairieAdresse || '';
    telClient = r.mairieTel || '';
  }
  return {
    num: num,
    dateStr: dateStr,
    nom: nomClient,
    adresse: adrClient,
    tel: telClient,
    email: r.email || '',
    type: descType,
    prixHT: r.prix,
    notes: isVP ? '' : (r.notes || ''), // les notes ne vont pas dans la description VP
    clientType: isVP ? '' : (r.clientType || ''), // pas besoin d'afficher "Voie publique" d√©j√† dans description
    insecte: r.insecte || '',
    adresseIntervention: isVP ? r.adresse : null // pour r√©f√©rence dans la facture VP
  };
}

function ouvrirFacture(rdvId) {
  var r = findById(rdvs, rdvId);
  if (!r) return;
  currentRdvId = rdvId;
  currentFactureId = null;
  var num = 'F' + new Date().getFullYear() + '-' + String(factures.length + 1).padStart(3, '0');
  document.getElementById('facture-modal-title').textContent = 'Nouvelle facture';
  var data = buildDataFacture(r, num, new Date().toLocaleDateString('fr-FR'));
  document.getElementById('facture-content').innerHTML = buildFactureHtml(data, true, r.clientType !== 'Voie publique');
  document.getElementById('btn-valider').style.display = 'inline-flex';
  document.getElementById('btn-mail').style.display = 'none';
  document.getElementById('modal-facture').classList.add('open');
  setTimeout(initSig, 120);
}

function voirFacture(factureId) {
  var f = findById(factures, factureId);
  if (!f) { showToast('Facture introuvable', true); return; }
  currentFactureId = factureId;
  currentRdvId = null;
  document.getElementById('facture-modal-title').textContent = 'Facture ' + f.num;
  document.getElementById('facture-content').innerHTML = buildFactureHtml({
    num: f.num,
    dateStr: new Date(f.date + 'T12:00:00').toLocaleDateString('fr-FR'),
    nom: f.nom, adresse: f.adresse, tel: f.tel, email: f.email || '',
    type: f.type, prixHT: f.prixHT, notes: f.notes || '',
    signature: f.signature || '', clientType: f.clientType || '',
    insecte: f.insecte || ''
  }, false, false);
  document.getElementById('btn-valider').style.display = 'none';
  var canMail = f.email && settings.ejsPub && settings.ejsSvc && settings.ejsTpl && f.clientType !== 'Voie publique';
  document.getElementById('btn-mail').style.display = canMail ? 'inline-flex' : 'none';
  document.getElementById('modal-facture').classList.add('open');
}

function validerFacture() {
  var r = findById(rdvs, currentRdvId);
  if (!r) return;
  var canvas = document.getElementById('sigCanvas');
  var sig = canvas ? canvas.toDataURL() : '';
  var emailClient = '';
  var fEmailEl = document.getElementById('f-email');
  if (fEmailEl) emailClient = fEmailEl.value.trim();

  var prixHT = r.prix;
  var num = 'F' + new Date().getFullYear() + '-' + String(factures.length + 1).padStart(3, '0');
  var data = buildDataFacture(r, num, new Date().toISOString().split('T')[0]);

  var f = {
    id: String(Date.now()),
    num: num,
    nom: data.nom,
    adresse: data.adresse,
    tel: data.tel,
    email: emailClient,
    type: data.type,
    prixHT: prixHT,
    prix: prixHT,
    notes: data.notes,
    clientType: data.clientType,
    insecte: r.insecte || '',
    date: new Date().toISOString().split('T')[0],
    signature: sig
  };
  factures.push(f);
  var idx = rdvs.findIndex(function(x) { return x.id === currentRdvId; });
  if (idx >= 0) rdvs[idx].factureId = f.id;
  save();
  closeModal('modal-facture');
  renderRdvs();
  renderDashboard();
  renderArchives();
  showToast('‚úì Facture archiv√©e !');

  if (emailClient && settings.ejsPub && settings.ejsSvc && settings.ejsTpl && r.clientType !== 'Voie publique') {
    setTimeout(function() { sendMailForFacture(f); }, 500);
  }
}

function sendMailCurrent() {
  var f = findById(factures, currentFactureId);
  if (f) sendMailForFacture(f);
}

function sendMailById(id) {
  var f = findById(factures, id);
  if (f) sendMailForFacture(f);
}

function sendMailForFacture(f) {
  var s = settings;
  if (!s.ejsPub || !s.ejsSvc || !s.ejsTpl) { showToast('Configurez EmailJS dans Param√®tres', true); return; }
  if (!f.email) { showToast('Aucun email client renseign√©', true); return; }
  showToast('üìß G√©n√©ration de la facture en image...');

  var tempDiv = document.createElement('div');
  tempDiv.style.cssText = 'position:fixed;left:-9999px;top:0;width:750px;background:#fff;z-index:-1';
  tempDiv.innerHTML = buildFactureHtml({
    num: f.num,
    dateStr: new Date(f.date + 'T12:00:00').toLocaleDateString('fr-FR'),
    nom: f.nom, adresse: f.adresse, tel: f.tel, email: f.email || '',
    type: f.type, prixHT: f.prixHT, notes: f.notes || '',
    signature: f.signature || ''
  }, false, false);
  document.body.appendChild(tempDiv);

  html2canvas(tempDiv, {
    scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false
  }).then(function(canvas) {
    document.body.removeChild(tempDiv);
    var base64 = canvas.toDataURL('image/jpeg', 0.92).split(',')[1];

    // Upload to ImgBB
    showToast('üì§ Upload de la facture...');
    var formData = new FormData();
    formData.append('image', base64);
    formData.append('name', 'facture_' + f.num);

    fetch('https://api.imgbb.com/1/upload?key=c06ab1e1493e951e257059b30f4bf58d', {
      method: 'POST',
      body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
      if (!result.success) throw new Error('ImgBB upload failed');
      var imageUrl = result.data.url;

      // Send email with image URL
      showToast('üìß Envoi du mail...');
      emailjs.send(s.ejsSvc, s.ejsTpl, {
        to_email: f.email,
        to_name: f.nom,
        from_name: s.nom || 'Allo √ßa pique',
        facture_num: f.num,
        facture_date: new Date(f.date + 'T12:00:00').toLocaleDateString('fr-FR'),
        intervention: f.type,
        montant: f.prix.toFixed(2) + ' ‚Ç¨',
        adresse: f.adresse,
        contact_tel: s.tel || '',
        contact_email: s.email || '',
        facture_image_url: imageUrl
      }).then(function() {
        showToast('‚úÖ Facture envoy√©e √† ' + f.email + ' !');
      }).catch(function(err) {
        console.error(err);
        showToast('‚ùå Erreur envoi mail. V√©rifiez vos cl√©s EmailJS.', true);
      });
    })
    .catch(function(err) {
      console.error(err);
      showToast('‚ùå Erreur upload image. R√©essayez.', true);
    });

  }).catch(function(err) {
    document.body.removeChild(tempDiv);
    console.error(err);
    showToast('‚ùå Erreur g√©n√©ration image', true);
  });
}

// SIGNATURE
function initSig() {
  var canvas = document.getElementById('sigCanvas');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#111';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  function getPos(e) {
    var rect = canvas.getBoundingClientRect();
    var src = e.touches ? e.touches[0] : e;
    return { x: src.clientX - rect.left, y: src.clientY - rect.top };
  }
  canvas.onmousedown = canvas.ontouchstart = function(e) {
    e.preventDefault();
    isDrawing = true;
    var p = getPos(e); lastX = p.x; lastY = p.y;
  };
  canvas.onmousemove = canvas.ontouchmove = function(e) {
    e.preventDefault();
    if (!isDrawing) return;
    var p = getPos(e);
    ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke();
    lastX = p.x; lastY = p.y;
  };
  canvas.onmouseup = canvas.onmouseleave = canvas.ontouchend = function() { isDrawing = false; };
}

function clearSig() {
  var c = document.getElementById('sigCanvas');
  if (c) c.getContext('2d').clearRect(0, 0, c.width, c.height);
}

// PHOTO CLOUDINARY
function prendrePhoto(rdvId) {
  var r = findById(rdvs, rdvId);
  if (!r) return;
  var cloudName = settings.cloudinaryCloud;
  var uploadPreset = settings.cloudinaryPreset;
  if (!cloudName || !uploadPreset) {
    showToast('Configurez Cloudinary dans Param√®tres', true);
    return;
  }
  // Cr√©er un input file cach√©
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.onchange = function() {
    var file = input.files[0];
    if (!file) return;
    showToast('üì§ Pr√©paration de la photo...');
    var reader = new FileReader();
    reader.onload = function(e) {
      // Compression via canvas pour r√©duire la taille
      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        var MAX = 1200;
        var w = img.width, h = img.height;
        if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
        if (h > MAX) { w = Math.round(w * MAX / h); h = MAX; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        var base64 = canvas.toDataURL('image/jpeg', 0.80);
        showToast('üì§ Upload vers Cloudinary...');
        var formData = new FormData();
        formData.append('file', base64);
        formData.append('upload_preset', uploadPreset);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.cloudinary.com/v1_1/' + cloudName + '/image/upload', true);
        xhr.onload = function() {
          try {
            var data = JSON.parse(xhr.responseText);
            if (data.error) throw new Error(data.error.message);
            var idx = rdvs.findIndex(function(x) { return x.id === rdvId; });
            if (idx >= 0) rdvs[idx].photoUrl = data.secure_url;
            save();
            renderRdvs();
            renderDashboard();
            renderArchives();
            showToast('‚úÖ Photo enregistr√©e !');
          } catch(err) {
            console.error('Cloudinary parse error:', err, xhr.responseText);
            showToast('‚ùå ' + (err.message || 'Erreur Cloudinary'), true);
          }
        };
        xhr.onerror = function() {
          console.error('XHR error', xhr.status, xhr.statusText);
          showToast('‚ùå Erreur r√©seau. V√©rifiez Cloud Name et Upload Preset.', true);
        };
        xhr.send(formData);
      };
      img.onerror = function() { showToast('‚ùå Impossible de lire l\'image', true); };
      img.src = e.target.result;
    };
    reader.onerror = function() { showToast('‚ùå Erreur lecture du fichier', true); };
    reader.readAsDataURL(file);
  };
  input.click();
}

// PRINT
function printFacture() {
  var content = document.getElementById('facture-content').innerHTML;
  var w = window.open('', '_blank');
  if (!w) { showToast('Autorisez les popups pour imprimer', true); return; }
  w.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Facture</title>'
    + '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">'
    + '<style>body{font-family:"DM Sans",sans-serif;margin:0;padding:20px;background:#fff;color:#111}.facture-wrap{max-width:700px;margin:auto}.f-title{font-family:"Syne",sans-serif;font-size:2rem;color:#f5a623;font-weight:800}.f-header{display:flex;justify-content:space-between;margin-bottom:24px;align-items:flex-start}.f-company-name{font-family:"Syne",sans-serif;font-weight:800;font-size:1rem;color:#f5a623}.f-meta{font-size:.85rem;color:#555;line-height:1.7}.f-parties{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:22px}.f-party{background:#f7f7f7;border-radius:8px;padding:14px}.f-party h4{font-size:.72rem;text-transform:uppercase;color:#888;margin-bottom:8px}.f-party p{font-size:.88rem;line-height:1.6}.f-table{width:100%;border-collapse:collapse;margin-bottom:18px}.f-table th{background:#f5a623;color:#fff;padding:9px 12px;text-align:left;font-size:.83rem}.f-table td{padding:10px 12px;border-bottom:1px solid #eee;font-size:.88rem}.f-total{text-align:right;margin-bottom:16px}.f-total-line{font-size:.88rem;color:#555;margin-bottom:3px}.f-total-ttc{font-size:1.2rem;font-weight:700;color:#111;margin-top:6px}.f-mention{font-size:.75rem;color:#888;border-top:1px solid #eee;padding-top:10px;margin-top:10px}.f-sig{margin-top:18px;border:2px dashed #ddd;border-radius:8px;padding:10px}.f-sig p{font-size:.8rem;color:#888;margin-bottom:6px}#sigCanvas,input[type=email],button.noprint{display:none}@media print{.noprint{display:none}}</style>'
    + '</head><body>' + content
    + '<br><button class="noprint" onclick="window.print()" style="margin-top:16px;padding:10px 22px;background:#f5a623;border:none;border-radius:8px;font-size:1rem;cursor:pointer">üñ®Ô∏è Imprimer / Enregistrer en PDF</button>'
    + '</body></html>');
  w.document.close();
}

// ARCHIVES
function renderArchives() {
  var sorted = factures.slice().sort(function(a,b) { return b.date.localeCompare(a.date); });
  var el = document.getElementById('archive-list');
  if (sorted.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üóÇÔ∏è</div><p>Aucune facture archiv√©e</p></div>';
    return;
  }
  var rows = sorted.map(function(f) {
    var d = new Date(f.date + 'T12:00:00').toLocaleDateString('fr-FR');
    var mailBtn = (f.email && settings.ejsPub && settings.ejsSvc && settings.ejsTpl && f.clientType !== 'Voie publique')
      ? '<button class="btn btn-ghost btn-sm" onclick="sendMailById(\'' + f.id + '\')">üìß</button>'
      : '';
    // R√©cup√©rer le RDV li√© pour la photo
    var rdvLie = rdvs.find(function(r) { return r.factureId === f.id; });
    var photoBtn = rdvLie && rdvLie.photoUrl
      ? '<a href="' + rdvLie.photoUrl + '" target="_blank" class="btn btn-ghost btn-sm" title="Voir photo nid">üì∏</a>'
      : '';
    return '<tr>'
      + '<td><strong>' + escHtml(f.num) + '</strong></td>'
      + '<td>' + d + '</td>'
      + '<td>' + escHtml(f.nom) + '</td>'
      + '<td>' + escHtml(f.type) + '</td>'
      + '<td><strong>' + f.prix.toFixed(2) + ' ‚Ç¨</strong></td>'
      + '<td style="white-space:nowrap;display:flex;gap:4px;flex-wrap:wrap">'
      + '<button class="btn btn-ghost btn-sm" onclick="voirFacture(\'' + f.id + '\')">üëÅ Voir</button>'
      + '<button class="btn btn-ghost btn-sm" onclick="voirEtImprimer(\'' + f.id + '\')">üñ®Ô∏è</button>'
      + mailBtn
      + photoBtn
      + '</td>'
      + '</tr>';
  }).join('');
  el.innerHTML = '<div class="card" style="padding:0;overflow:hidden"><table class="archive-table"><thead><tr><th>N¬∞</th><th>Date</th><th>Client</th><th>Intervention</th><th>Montant</th><th>Actions</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
}

function voirEtImprimer(id) {
  voirFacture(id);
  setTimeout(printFacture, 500);
}

// SETTINGS
function renderSettings() {
  document.getElementById('s-nom').value = settings.nom || '';
  document.getElementById('s-siret').value = settings.siret || '';
  document.getElementById('s-adresse').value = settings.adresse || '';
  document.getElementById('s-ville').value = settings.ville || '';
  document.getElementById('s-tel').value = settings.tel || '';
  document.getElementById('s-email').value = settings.email || '';
  document.getElementById('s-mention').value = settings.mention || 'TVA non applicable, art. 293B du CGI';
  document.getElementById('s-ejs-pub').value = settings.ejsPub || '';
  document.getElementById('s-ejs-svc').value = settings.ejsSvc || '';
  document.getElementById('s-ejs-tpl').value = settings.ejsTpl || '';
  document.getElementById('s-cloudinary-cloud').value = settings.cloudinaryCloud || '';
  document.getElementById('s-cloudinary-preset').value = settings.cloudinaryPreset || '';
  renderTarifGrid();
}

function saveSettings() {
  settings = {
    nom: document.getElementById('s-nom').value.trim(),
    siret: document.getElementById('s-siret').value.trim(),
    adresse: document.getElementById('s-adresse').value.trim(),
    ville: document.getElementById('s-ville').value.trim(),
    tel: document.getElementById('s-tel').value.trim(),
    email: document.getElementById('s-email').value.trim(),
    mention: document.getElementById('s-mention').value.trim(),
    ejsPub: document.getElementById('s-ejs-pub').value.trim(),
    ejsSvc: document.getElementById('s-ejs-svc').value.trim(),
    ejsTpl: document.getElementById('s-ejs-tpl').value.trim(),
    cloudinaryCloud: document.getElementById('s-cloudinary-cloud').value.trim(),
    cloudinaryPreset: document.getElementById('s-cloudinary-preset').value.trim()
  };
  // Sauvegarder la grille tarifaire
  tarifs = {};
  document.querySelectorAll('#tarif-grid-container input[data-key]').forEach(function(inp) {
    tarifs[inp.dataset.key] = parseFloat(inp.value) || 0;
  });
  save();
  initEmailJS();
  showToast('Param√®tres enregistr√©s !');
}

function renderTarifGrid() {
  var container = document.getElementById('tarif-grid-container');
  if (!container) return;
  var html = '';
  INSECTES.forEach(function(ins) {
    html += '<div class="tarif-grid-section">';
    html += '<h4>' + ins.label + '</h4>';
    html += '<table class="tarif-grid-table"><thead><tr><th>Emplacement</th><th style="text-align:right">Prix (‚Ç¨ HT)</th></tr></thead><tbody>';
    EMPLACEMENTS.forEach(function(emp) {
      var key = ins.id + '_' + emp.id;
      var prix = tarifs[key] !== undefined ? tarifs[key] : 0;
      html += '<tr>';
      html += '<td>' + emp.label + '</td>';
      html += '<td style="text-align:right"><input type="number" data-key="' + key + '" value="' + prix + '" min="0" step="0.01"></td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
  });
  container.innerHTML = html;
}

// Kept for compatibility
function renderTarifs() { renderTarifGrid(); }
function addTarif() {}
function removeTarif(i) {}

// UTILS
function findById(arr, id) {
  return arr.find(function(x) { return x.id === id; }) || null;
}

function initEmailJS() {
  if (settings.ejsPub) {
    try { emailjs.init({ publicKey: settings.ejsPub }); } catch(e) { console.warn('EmailJS:', e); }
  }
}

// INIT
initEmailJS();
renderDashboard();
if (!settings.nom) {
  settings.nom = 'Allo √ßa pique';
  setTimeout(function() {
    goTo('settings');
    showToast('üëã V√©rifiez vos infos dans Param√®tres avant de commencer !');
  }, 600);
}
</script>
</body>
</html>
